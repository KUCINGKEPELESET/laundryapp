<!DOCTYPE html>

<html class="light" lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Laundry Service Dashboard</title>
  <!-- Google Fonts: Manrope -->
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&amp;display=swap"
    rel="stylesheet" />
  <!-- Material Symbols -->
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
    rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
    rel="stylesheet" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script
    id="tailwind-config">tailwind.config = { darkMode: "class", theme: { extend: { colors: { primary: "#006e7a", "primary-light": "#4597a1", "background-light": "#f5f8f8", "background-dark": "#0f2123", "surface-light": "#f0f7f8", "surface-dark": "#232d36", "accent-blush": "#FFB4A2" }, fontFamily: { display: "Manrope" }, borderRadius: { DEFAULT: "0.125rem", lg: "0.25rem", xl: "0.5rem", full: "0.75rem" }, boxShadow: { soft: "0 4px 20px -2px rgba(0, 0, 0, 0.05)", glow: "0 0 15px rgba(0, 110, 122, 0.3)" } } } };</script>
  <style>
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .glass-nav {
      background: rgba(252, 253, 253, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-top: 1px solid rgba(0, 0, 0, 0.05);
    }

    .dark .glass-nav {
      background: rgba(26, 33, 40, 0.85);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
  </style>


</head>

<body
  class="bg-gray-100 flex justify-center items-center min-h-screen font-display antialiased selection:bg-primary selection:text-white">
  <!-- Phone Container -->
  <div
    class="relative flex h-[100dvh] w-full max-w-md flex-col bg-background-light dark:bg-background-dark overflow-hidden shadow-2xl sm:rounded-3xl sm:my-8 sm:h-[calc(100vh-4rem)]">
    <!-- Status Bar Area (Visual Spacer) -->
    <div class="h-12 w-full shrink-0 bg-transparent"></div>
    <!-- Scrollable Content -->
    <div class="flex-1 overflow-y-auto hide-scrollbar pb-24">
      <!-- Header -->
      <header class="px-6 py-2 flex items-center justify-between">
        <div>
          <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Tuesday, 14 Oct</p>
          <h1 id="username-display" class="text-slate-900 dark:text-white text-2xl font-extrabold tracking-tight">Hello,
            Alex</h1>
        </div>
        <button
          class="relative p-2 rounded-full hover:bg-surface-light dark:hover:bg-surface-dark transition-colors group">
          <span class="material-symbols-outlined text-slate-900 dark:text-white"
            style="font-size: 28px;">notifications</span>
          <span
            class="absolute top-2 right-2.5 h-2.5 w-2.5 rounded-full bg-accent-blush border-2 border-background-light dark:border-background-dark"></span>
        </button>
      </header>
      <!-- Wallet Card -->
      <section class="px-6 mt-6">
        <div class="relative overflow-hidden rounded-2xl bg-[#e6f3f4] dark:bg-surface-dark p-6 shadow-soft">
          <!-- Abstract decorative circle -->
          <div class="absolute -right-10 -top-10 h-40 w-40 rounded-full bg-primary/10 blur-2xl"></div>
          <div class="relative z-10 flex flex-col gap-6">
            <div class="flex justify-between items-start">
              <div>
                <p class="text-primary-light dark:text-slate-400 text-sm font-semibold uppercase tracking-wider mb-1">
                  Total Balance</p>
                <h2 class="text-slate-900 dark:text-white text-4xl font-bold tracking-tight">$45.50</h2>
              </div>
              <div class="h-10 w-10 flex items-center justify-center rounded-full bg-white dark:bg-slate-700 shadow-sm">
                <span class="material-symbols-outlined text-primary"
                  style="font-size: 24px;">account_balance_wallet</span>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <button
                class="flex-1 flex items-center justify-center gap-2 rounded-xl bg-primary text-white h-12 text-sm font-bold shadow-glow hover:bg-primary/90 transition-colors">
                <span class="material-symbols-outlined" style="font-size: 20px;">add</span>
                Top Up
              </button>
              <button onclick="window.location.href='wallet.html'"
                class="h-12 w-12 flex items-center justify-center rounded-xl border border-primary/20 text-primary dark:text-white hover:bg-primary/5 transition-colors">
                <span class="material-symbols-outlined" style="font-size: 20px;">history</span>
              </button>
            </div>
          </div>
        </div>
      </section>
      <!-- Quick Action: New Order -->
      <section class="px-6 mt-8">
        <button id="new-order-button"
          class="group relative w-full overflow-hidden rounded-2xl bg-slate-900 dark:bg-white p-1 shadow-lg transition-transform active:scale-[0.98]">
          <div
            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent opacity-0 transition-opacity group-hover:opacity-100">
          </div>
          <div class="flex h-16 items-center justify-between rounded-xl px-6">
            <div class="flex flex-col items-start">
              <span class="text-lg font-bold text-white dark:text-slate-900">New Laundry Order</span>
              <span class="text-xs font-medium text-slate-400 dark:text-slate-500">Pickup available today</span>
            </div>
            <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary text-white">
              <span class="material-symbols-outlined">local_laundry_service</span>
            </div>
          </div>
        </button>
      </section>
      <!-- Active Orders Section -->
      <section class="mt-10">
        <div class="flex items-center justify-between px-6 mb-4">
          <h3 class="text-slate-900 dark:text-white text-lg font-bold">In Progress</h3>
          <a class="text-primary text-sm font-semibold" href="orders.html">See All</a>
        </div>
        <div id="active-orders-container" class="space-y-4">
          <!-- Dynamic Orders will be injected here -->
          <div class="px-6 flex flex-col items-center justify-center py-6 text-slate-400">
            <p class="text-xs">Loading orders...</p>
          </div>
        </div>
      </section>

      <script>
        (function () {
          const container = document.getElementById('active-orders-container');

          function getProgress(status) {
            const map = {
              'Pending Payment': 5,
              'Paid': 10,
              'Request Received': 15,
              'Pickup Assigned': 20,
              'Washing': 35,
              'Drying': 50,
              'Ironing': 65,
              'Ironing/Folding': 65,
              'Packing': 80,
              'Ready for Delivery': 90,
              'Out for Delivery': 95,
              'Completed': 100
            };
            return map[status] || 15;
          }

          function getStatusColor(status) {
            if (status === 'Completed') return 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300';
            if (status === 'Ready for Delivery') return 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300';
            if (status === 'Out for Delivery') return 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300';
            if (status === 'Pending Payment') return 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300';
            return 'bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300';
          }

          // Wait for auth to be ready to filter
          auth.onAuthStateChanged((user) => {
            if (!user) {
              container.innerHTML = '<div class="px-6 py-4 text-center text-slate-400 text-xs">Please login to see orders</div>';
              return;
            }

            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            // Filter by User ID
            const myOrders = orders.filter(o => o.userId === user.uid);

            // Filter only Active orders (exclude Completed/Cancelled) for this widget
            // We want to show what is currently happening.
            const activeOrders = myOrders.filter(o => o.status !== 'Completed' && o.status !== 'Cancelled');
            const sorted = activeOrders.reverse();

            if (sorted.length === 0) {
              container.innerHTML = `
                    <div class="px-6 flex flex-col items-center justify-center py-6 text-slate-400">
                        <span class="material-symbols-outlined mb-2">local_laundry_service</span>
                        <p class="text-xs">No active orders</p>
                    </div>
                  `;
              return;
            }

            let html = '';
            // Take top 2
            sorted.slice(0, 2).forEach(order => {
              const progress = getProgress(order.status);
              let icon = 'water_drop';
              if (order.status === 'Completed') icon = 'check_circle';
              else if (order.status === 'Out for Delivery') icon = 'local_shipping';
              else if (['Washing', 'Drying', 'Ironing', 'Ironing/Folding', 'Packing', 'Ready for Delivery'].includes(order.status)) icon = 'local_laundry_service';
              else if (order.status === 'Request Received' || order.status === 'Paid') icon = 'receipt_long';

              html += `
                <div class="px-6 cursor-pointer" onclick="window.location.href='order_tracking.html?id=${order.id}'">
                  <div class="flex flex-col gap-4 rounded-2xl border border-slate-100 bg-white dark:bg-surface-dark dark:border-slate-800 p-4 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                      <div class="flex gap-4">
                        <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-primary/10 text-primary">
                          <span class="material-symbols-outlined">${icon}</span>
                        </div>
                        <div>
                          <p class="text-slate-900 dark:text-white text-base font-bold">Order #${order.id}</p>
                          <p class="text-slate-500 dark:text-slate-400 text-xs font-medium mt-0.5">${order.service} • ${order.status}</p>
                        </div>
                      </div>
                      <span class="rounded-full px-2.5 py-1 text-xs font-bold ${getStatusColor(order.status)}">${order.status}</span>
                    </div>
                    <!-- Progress -->
                    <div class="space-y-2">
                      <div class="flex justify-between text-xs font-medium text-slate-400">
                        <span>Progress</span>
                        <span class="text-primary">${progress}%</span>
                      </div>
                      <div class="h-2 w-full overflow-hidden rounded-full bg-slate-100 dark:bg-slate-700">
                        <div class="h-full rounded-full bg-primary transition-all duration-500" style="width: ${progress}%"></div>
                      </div>
                    </div>
                  </div>
                </div>
                `;
            });
            container.innerHTML = html;
          });
        })();
      </script>
      <!-- Subscription Status -->
      <section class="mt-10 px-6">
        <div class="relative overflow-hidden rounded-2xl bg-slate-900 dark:bg-black p-5 text-white">
          <div
            class="absolute right-0 top-0 -mt-4 -mr-4 h-32 w-32 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 opacity-20 blur-2xl">
          </div>
          <div class="relative z-10 flex items-center justify-between">
            <div>
              <div class="flex items-center gap-2 mb-2">
                <span class="material-symbols-outlined text-yellow-400"
                  style="font-size: 20px;">workspace_premium</span>
                <h3 class="text-sm font-bold uppercase tracking-wider text-yellow-400">Gold Member</h3>
              </div>
              <p class="text-2xl font-bold">12 lbs</p>
              <p class="text-xs text-slate-400">Remaining allowance this month</p>
            </div>
            <div class="h-14 w-14 rounded-full border-4 border-slate-800 flex items-center justify-center relative">
              <span class="text-xs font-bold">75%</span>
              <svg class="absolute inset-0 -rotate-90" viewbox="0 0 36 36">
                <path class="text-slate-800"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                  stroke="currentColor" stroke-width="4"></path>
                <path class="text-yellow-400"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                  stroke="currentColor" stroke-dasharray="75, 100" stroke-width="4"></path>
              </svg>
            </div>
          </div>
        </div>
      </section>
      <!-- Promotions Carousel -->
      <section class="mt-10 mb-6">
        <h3 class="text-slate-900 dark:text-white text-lg font-bold px-6 mb-4">Special Offers</h3>
        <div class="flex gap-4 overflow-x-auto px-6 pb-4 hide-scrollbar snap-x snap-mandatory">
          <!-- Promo 1 -->
          <div
            class="snap-center shrink-0 w-[280px] rounded-2xl bg-white dark:bg-surface-dark shadow-sm overflow-hidden border border-slate-100 dark:border-slate-800 flex flex-col">
            <div class="h-32 w-full bg-cover bg-center" data-alt="Neat stack of folded towels with soft lighting"
              style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuBKxwosZvnUp7JIJcrCU9Q1MeAsI-ydh8QWnHCIiUZYHHf0J5UED6rWtZUevOTeesrB4DBg7IRp01DBl1bXhekH2EFp323eJ2_Ssh12czujmNn5Kq1A9f-J3AtTzsouakDWJXvEOtyTaPRO8TOqlHK2_-n661H7RoN3gLeDGH0Z0G_lNMD--zz6DO763FU2o24qZC2U5lZ-O9SplMqi6gT09OJsuB5xHAWHDe6ef3pFPXeSElZLLEPWBtpMzmpYT9z7c-TrLG1RVoqx');">
            </div>
            <div class="p-4">
              <span
                class="inline-block px-2 py-1 rounded bg-accent-blush/20 text-orange-600 text-[10px] font-bold uppercase tracking-wide mb-2">New
                Customer</span>
              <h4 class="text-slate-900 dark:text-white font-bold text-base leading-tight mb-1">Get $10 Off Dry Cleaning
              </h4>
              <p class="text-slate-500 dark:text-slate-400 text-xs">Use code FIRSTDRY10 at checkout.</p>
            </div>
          </div>
          <!-- Promo 2 -->
          <div
            class="snap-center shrink-0 w-[280px] rounded-2xl bg-white dark:bg-surface-dark shadow-sm overflow-hidden border border-slate-100 dark:border-slate-800 flex flex-col">
            <div class="h-32 w-full bg-cover bg-center" data-alt="Clean minimal laundry room interior"
              style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuD64VWmin4srbMQ_suu_31gllUM7IEOMsjVwyQTAO5s82UUnBsCMfAF1WskuaOmF8IPysKHjGHlhiyh-_FItvLlEz1Rs_9EXshRsmneDXkG3HX9h6g-wEUnfMfj2_kSbhQMtbNAJRA5NXcWk_NOgxkumQ_Ws_RPiAhTOcEW47P53F_NBzJfAcmKZcaykjb80c-LHfFRn2gsxFxkGT0ld-C75iqU77gN2I_zEOfL6PVhRb3eZIkuqJhHxdi-LMi2aX8EceRothy6F3TB');">
            </div>
            <div class="p-4">
              <span
                class="inline-block px-2 py-1 rounded bg-primary/10 text-primary text-[10px] font-bold uppercase tracking-wide mb-2">Seasonal</span>
              <h4 class="text-slate-900 dark:text-white font-bold text-base leading-tight mb-1">Spring Cleaning Bundle
              </h4>
              <p class="text-slate-500 dark:text-slate-400 text-xs">Refresh your curtains and linens.</p>
            </div>
          </div>
        </div>
      </section>
    </div>
    <!-- Bottom Navigation -->
    <nav
      class="absolute bottom-6 left-6 right-6 rounded-2xl glass-nav py-3 z-30 border border-slate-200 dark:border-slate-800 shadow-xl">
      <div class="flex justify-around items-end h-16 px-2">
        <button class="flex flex-col items-center justify-center w-full gap-1 text-primary">
          <span class="material-symbols-outlined fill-1" style="font-variation-settings: 'FILL' 1;">home</span>
          <span class="text-[10px] font-bold">Home</span>
        </button>
        <button onclick="window.location.href='orders.html'"
          class="flex flex-col items-center justify-center w-full gap-1 text-slate-400 dark:text-slate-500 hover:text-primary transition-colors">
          <span class="material-symbols-outlined">receipt_long</span>
          <span class="text-[10px] font-medium">Orders</span>
        </button>
        <button onclick="window.location.href='wallet.html'"
          class="flex flex-col items-center justify-center w-full gap-1 text-slate-400 dark:text-slate-500 hover:text-primary transition-colors">
          <span class="material-symbols-outlined">account_balance_wallet</span>
          <span class="text-[10px] font-medium">Wallet</span>
        </button>
        <button onclick="window.location.href='profile.html'"
          class="flex flex-col items-center justify-center w-full gap-1 text-slate-400 dark:text-slate-500 hover:text-primary transition-colors">
          <span class="material-symbols-outlined">person</span>
          <span class="text-[10px] font-medium">Profile</span>
        </button>
      </div>
    </nav>
    <!-- iOS Home Indicator -->
    <div class="absolute bottom-1 left-1/2 -translate-x-1/2 w-1/3 h-1 bg-slate-900/20 dark:bg-white/20 rounded-full">
    </div>
  </div>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/init_supabase.js"></script>
  <script>
    (async function () {
      // Check Auth
      const { data: { user } } = await window.sb.auth.getUser();
      const container = document.getElementById('active-orders-container');

      if (!user) {
        if (container) container.innerHTML = '<div class="px-6 py-4 text-center text-slate-400 text-xs">Please login to see orders</div>';
        // console.log("No user logged in, redirecting...");
        // window.location.href = 'login.html'; 
        return;
      }

      // Display Name
      const name = user.user_metadata.full_name || user.email.split('@')[0];
      const displayName = name.charAt(0).toUpperCase() + name.slice(1);
      document.getElementById('username-display').innerText = `Hello, ${displayName}`;

      // Fetch Orders from Supabase
      async function fetchOrders() {
        const { data: orders, error } = await window.sb
          .from('orders')
          .select('*')
          .eq('user_id', user.id)
          .neq('status', 'Completed') // Active only
          .neq('status', 'Cancelled')
          .order('created_at', { ascending: false })
          .limit(2);

        if (error) {
          console.error("Error fetching orders:", error);
          container.innerHTML = `<div class="px-6 py-4 text-center text-red-500 text-xs">Error loading orders</div>`;
          return;
        }

        if (!orders || orders.length === 0) {
          container.innerHTML = `
                    <div class="px-6 flex flex-col items-center justify-center py-6 text-slate-400">
                        <span class="material-symbols-outlined mb-2">local_laundry_service</span>
                        <p class="text-xs">No active orders</p>
                    </div>`;
          return;
        }

        renderOrders(orders);
      }

      function getProgress(status) {
        const map = {
          'Pending Payment': 5,
          'Paid': 10,
          'Request Received': 15,
          'Pickup Assigned': 20,
          'Washing': 35,
          'Drying': 50,
          'Ironing': 65,
          'Ironing/Folding': 65,
          'Packing': 80,
          'Ready for Delivery': 90,
          'Out for Delivery': 95,
          'Completed': 100
        };
        return map[status] || 15;
      }

      function getStatusColor(status) {
        if (status === 'Completed') return 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300';
        if (status === 'Ready for Delivery') return 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300';
        if (status === 'Out for Delivery') return 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300';
        if (status === 'Pending Payment') return 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300';
        return 'bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300';
      }

      function renderOrders(orders) {
        let html = '';
        orders.forEach(order => {
          const progress = getProgress(order.status);
          let icon = 'water_drop';
          if (order.status === 'Completed') icon = 'check_circle';
          else if (order.status === 'Out for Delivery') icon = 'local_shipping';
          else if (['Washing', 'Drying', 'Ironing', 'Ironing/Folding', 'Packing', 'Ready for Delivery'].includes(order.status)) icon = 'local_laundry_service';
          else if (order.status === 'Request Received' || order.status === 'Paid') icon = 'receipt_long';

          html += `
                <div class="px-6 cursor-pointer" onclick="window.location.href='order_tracking.html?id=${order.id}'">
                  <div class="flex flex-col gap-4 rounded-2xl border border-slate-100 bg-white dark:bg-surface-dark dark:border-slate-800 p-4 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                      <div class="flex gap-4">
                        <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-xl bg-primary/10 text-primary">
                          <span class="material-symbols-outlined">${icon}</span>
                        </div>
                        <div>
                          <p class="text-slate-900 dark:text-white text-base font-bold">Order #${order.id.slice(0, 8)}...</p>
                          <p class="text-slate-500 dark:text-slate-400 text-xs font-medium mt-0.5">${order.service} • ${order.status}</p>
                        </div>
                      </div>
                      <span class="rounded-full px-2.5 py-1 text-xs font-bold ${getStatusColor(order.status)}">${order.status}</span>
                    </div>
                    <!-- Progress -->
                    <div class="space-y-2">
                      <div class="flex justify-between text-xs font-medium text-slate-400">
                        <span>Progress</span>
                        <span class="text-primary">${progress}%</span>
                      </div>
                      <div class="h-2 w-full overflow-hidden rounded-full bg-slate-100 dark:bg-slate-700">
                        <div class="h-full rounded-full bg-primary transition-all duration-500" style="width: ${progress}%"></div>
                      </div>
                    </div>
                  </div>
                </div>
                `;
        });
        container.innerHTML = html;
      }

      // Initial Fetch
      fetchOrders();

      // Optional: Polling every 10s for updates (Poor man's realtime, simpler than implementing channels for now)
      setInterval(fetchOrders, 10000);

    })();

    document.getElementById('new-order-button').addEventListener('click', function () {
      window.location.href = 'new_order.html';
    });
  </script>
</body>

</html>